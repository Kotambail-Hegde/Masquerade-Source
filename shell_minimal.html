<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
    <title>Dear ImGui Emscripten example</title>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html, body {
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        background-color: black;
        touch-action: none;
      }

      canvas.emscripten {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        border: 0;
        margin: 0;
        padding: 0;
        display: block;

        image-rendering: pixelated;
        image-rendering: crisp-edges;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-optimize-contrast;
      }
    </style>
  </head>

  <body>
    <canvas class="emscripten" id="canvas"
            oncontextmenu="event.preventDefault()"></canvas>

    <script type="text/javascript">
      var Module = {
        preRun: [],
        postRun: [],

        print: function () {
          console.log(Array.prototype.slice.call(arguments).join(" "));
        },

        printErr: function () {
          console.error(Array.prototype.slice.call(arguments).join(" "));
        },

        canvas: (function () {
          return document.getElementById("canvas");
        })(),

        setStatus: function (text) {
          console.log("status:", text);
        },

        monitorRunDependencies: function () {},

        // Disable SDL auto HiDPI handling (we control it manually)
        SDL: {
          hints: {
            SDL_HINT_VIDEO_HIGHDPI_DISABLED: "1"
          }
        }
      };

      // ---------------- DPI-safe canvas resize ----------------

      function resizeCanvasToDisplaySize() {
        const canvas = Module.canvas;
        if (!canvas) return;

        const dpr = window.devicePixelRatio || 1;

        const cssWidth  = canvas.clientWidth;
        const cssHeight = canvas.clientHeight;

        const displayWidth  = Math.round(cssWidth  * dpr);
        const displayHeight = Math.round(cssHeight * dpr);

        if (canvas.width !== displayWidth ||
            canvas.height !== displayHeight) {

          canvas.width  = displayWidth;
          canvas.height = displayHeight;

          if (Module._emscripten_set_canvas_element_size) {
            Module._emscripten_set_canvas_element_size(
              canvas.id,
              displayWidth,
              displayHeight
            );
          }
        }
      }

      // Resize on load + window resize
      window.addEventListener("resize", resizeCanvasToDisplaySize);

      // Detect DPR changes (monitor move, scaling change)
      let __lastDPR = window.devicePixelRatio;
      setInterval(() => {
        if (window.devicePixelRatio !== __lastDPR) {
          __lastDPR = window.devicePixelRatio;
          resizeCanvasToDisplaySize();
        }
      }, 250);

      Module.onRuntimeInitialized = function () {
        resizeCanvasToDisplaySize();
      };

      // ---------------- ROM argument parsing (unchanged) ----------------

      (function () {
        var params = new URLSearchParams(window.location.search);
        var romCount = parseInt(params.get("roms") || "0", 10);
        Module.arguments = [];

        for (let i = 0; i < romCount; ++i) {
          let rom = params.get("rom" + i);
          if (rom) {
            rom = rom.replace(/^\//, "");
            rom = "/" + rom;
            Module.arguments.push(rom);
          }
        }
      })();

      window.onerror = function (event) {
        console.log("onerror:", event);
      };
    </script>

    {{{ SCRIPT }}}
  </body>
</html>
